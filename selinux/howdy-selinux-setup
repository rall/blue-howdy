#!/usr/bin/env bash
set -euo pipefail

TE="/usr/share/selinux/howdy/howdy_gdm.te"
WRK="/run/howdy"
LOG_TAG="howdy-selinux-setup"

log(){ logger -t "$LOG_TAG" -- "$*"; }

# Resolve semodule path (prefer absolute), bail quietly if missing
SEM="/usr/sbin/semodule"
[ -x "$SEM" ] || SEM="$(command -v semodule || true)"
if [ -z "${SEM:-}" ]; then
  log "semodule not found; is policycoreutils installed? skipping"
  exit 0
fi

# Only act on SELinux-enabled systems
if ! sestatus >/dev/null 2>&1 || ! sestatus 2>/dev/null | grep -q 'enabled'; then
  exit 0
fi

# Exit if already installed
if "$SEM" -l | awk '{print $1}' | grep -qx howdy_gdm; then
  exit 0
fi

install -d -m0755 "$WRK"
cp -f "$TE" "$WRK/"

# Prefer devel Makefile; else fall back to raw toolchain (module ver 21)
if [ -f /usr/share/selinux/devel/Makefile ]; then
  log "building via devel Makefile"
  make -s -f /usr/share/selinux/devel/Makefile -C "$WRK" howdy_gdm.pp
else
  log "building via checkmodule/semodule_package (c=21)"
  checkmodule -M -m -c 21 -o "$WRK/howdy_gdm.mod" "$WRK/howdy_gdm.te"
  semodule_package -o "$WRK/howdy_gdm.pp" -m "$WRK/howdy_gdm.mod"
fi

# Try to install the compiled module
if "$SEM" -i "$WRK/howdy_gdm.pp" 2>/dev/null; then
  log "installed TE module"
  exit 0
fi

# Optional: AVC-derived module (still enforcing; no permissive)
if command -v ausearch >/dev/null && command -v audit2allow >/dev/null; then
  (ausearch -m avc -ts boot || ausearch -m avc -ts recent) > "$WRK/howdy.avc" || true
  if [ -s "$WRK/howdy.avc" ]; then
    log "installing AVC-derived module"
    audit2allow -M howdy_gdm_auto -i "$WRK/howdy.avc" && "$SEM" -X 400 -i howdy_gdm_auto.pp || true
  fi
fi

# Done. No permissive fallback.
exit 0
